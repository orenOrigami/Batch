<script>
  async function sendDataToWebhook() {
    const query = document.getElementById('searchQuery').value;
    const resultDiv = document.getElementById('result');
    resultDiv.innerHTML = 'Sending request...';

    if (!query) {
      resultDiv.innerHTML = 'Please enter a search query.';
      return;
    }

    try {
      // Initial webhook request
      const webhookURL = 'https://hook.eu2.make.com/iwj2tdngzc2i54k2l1z68xxthusblt2r';
      const response = await fetch(webhookURL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          searchQuery: query
        })
      });

      console.log('Initial Response Status:', response.status);

      if (response.status === 202 || response.ok) {
        resultDiv.innerHTML = 'Request accepted, waiting for response...';

        // Polling loop
        let finalResponse;
        for (let i = 0; i < 10; i++) { // Poll up to 10 times
          await new Promise(resolve => setTimeout(resolve, 3000)); // Wait 3 seconds
          
          // Replace with actual endpoint to check status or get the result
          finalResponse = await fetch(webhookURL + '/status'); 
          const text = await finalResponse.text();

          console.log(`Polling attempt ${i + 1}:`, text);

          if (finalResponse.ok && text.startsWith('http')) {
            resultDiv.innerHTML = `<button onclick="window.location.href='${text.trim()}'">Redirect to Batch</button>`;
            return;
          }
        }

        resultDiv.innerHTML = 'Final response not received in time. Try again later.';
      } else {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
    } catch (error) {
      resultDiv.innerHTML = `Error contacting webhook: ${error.message}`;
      console.error('Error:', error);
    }
  }
</script>
